<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>pathfinder visualizer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #fff;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #4CAF50;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .info {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info h3 {
      color: #4CAF50;
      margin-bottom: 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }

    .stat-label {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    #grid-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    #grid {
      display: inline-grid;
      gap: 1px;
      background: #000;
      padding: 10px;
      border-radius: 8px;
    }

    .cell {
      width: 40px;
      height: 40px;
      background: #2d2d2d;
      border: 1px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #666;
      position: relative;
      transition: all 0.3s;
    }

    .cell.empty {
      background: #2d2d2d;
    }

    .cell.start {
      background: #4CAF50;
      color: #fff;
      font-weight: bold;
      font-size: 14px;
    }

    .cell.end {
      background: #f44336;
      color: #fff;
      font-weight: bold;
      font-size: 14px;
    }

    .cell.obstacle {
      background: #000;
      border-color: #666;
    }

    .cell.waypoint {
      background: #2196F3;
      color: #fff;
      font-size: 14px;
    }

    .cell.path {
      background: #FFC107;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #666;
    }

    .routes-list {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .route-item {
      background: #1e1e1e;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      border-left: 4px solid #4CAF50;
    }

    .route-item:hover {
      background: #252525;
      cursor: pointer;
    }

    .status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status.loading {
      background: #FF9800;
    }

    .status.error {
      background: #f44336;
    }

    .instructions {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .instructions h3 {
      color: #4CAF50;
      margin-bottom: 15px;
    }

    .instructions ol {
      margin-left: 20px;
    }

    .instructions li {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .instructions code {
      background: #1e1e1e;
      padding: 2px 6px;
      border-radius: 3px;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="status" id="status">conectando...</div>

  <div class="container">
    <h1>ðŸŽ¯ pathfinder visualizer</h1>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="map-count">0</div>
        <div class="stat-label">mapas</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="obstacle-count">0</div>
        <div class="stat-label">obstaculos</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="waypoint-count">0</div>
        <div class="stat-label">waypoints</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="route-count">0</div>
        <div class="stat-label">rutas</div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #4CAF50;"></div>
        <span>inicio</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #f44336;"></div>
        <span>fin</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #FFC107;"></div>
        <span>camino</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #2196F3;"></div>
        <span>waypoint</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #000;"></div>
        <span>obstaculo</span>
      </div>
    </div>

    <div id="grid-container">
      <div id="grid"></div>
    </div>

    <div class="info">
      <h3>ultima ruta calculada</h3>
      <div id="route-info">no hay rutas calculadas aun</div>
    </div>

    <div class="routes-list">
      <h3>historial de rutas</h3>
      <div id="routes-history"></div>
    </div>

    <div class="instructions">
      <h3>como usar</h3>
      <ol>
        <li>abre postman o usa curl</li>
        <li>crea un mapa: <code>POST http://localhost:3000/api/maps {"name":"test","width":10,"height":10}</code></li>
        <li>agrega obstaculos: <code>POST http://localhost:3000/api/obstacles {"mapId":1,"x":5,"y":5}</code></li>
        <li>calcula ruta: <code>POST http://localhost:3000/api/routes {"mapId":1,"start":{"x":0,"y":0},"end":{"x":9,"y":9}}</code></li>
        <li>el visualizador se actualiza automaticamente cada 2 segundos</li>
      </ol>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    let currentMap = null;
    let currentObstacles = [];
    let currentWaypoints = [];
    let currentRoute = null;

    function updateStatus(message, type = 'loading') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
    }

    async function fetchData() {
      try {
        updateStatus('cargando datos...', 'loading');

        const [maps, obstacles, waypoints, routes] = await Promise.all([
          fetch(`${API_URL}/maps`).then(r => r.json()),
          fetch(`${API_URL}/obstacles`).then(r => r.json()),
          fetch(`${API_URL}/waypoints`).then(r => r.json()),
          fetch(`${API_URL}/routes/1`).then(r => r.ok ? r.json() : null)
        ]);

        document.getElementById('map-count').textContent = maps.length || 0;
        document.getElementById('obstacle-count').textContent = obstacles.length || 0;
        document.getElementById('waypoint-count').textContent = waypoints.length || 0;

        if (maps.length > 0) {
          currentMap = maps[maps.length - 1];
          currentObstacles = obstacles.filter(o => o.mapId === currentMap.id);
          currentWaypoints = waypoints.filter(w => w.mapId === currentMap.id);
          currentRoute = routes;
          
          renderGrid();
          renderRouteInfo();
        }

        await fetchRoutesHistory();
        updateStatus('conectado', 'success');
      } catch (error) {
        console.error('error:', error);
        updateStatus('error de conexion', 'error');
      }
    }

    async function fetchRoutesHistory() {
      try {
        const response = await fetch(`${API_URL}/routes`);
        if (!response.ok) return;
        
        const routes = await response.json();
        document.getElementById('route-count').textContent = routes.length || 0;
        
        const historyDiv = document.getElementById('routes-history');
        if (routes.length === 0) {
          historyDiv.innerHTML = '<p style="color: #666;">no hay rutas calculadas</p>';
          return;
        }

        historyDiv.innerHTML = routes.slice(-5).reverse().map(route => `
          <div class="route-item" onclick="selectRoute(${route.id})">
            <div><strong>ruta #${route.id}</strong></div>
            <div>inicio: (${route.startX}, ${route.startY}) â†’ fin: (${route.endX}, ${route.endY})</div>
            <div>distancia: ${route.distance} pasos</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('error fetching routes:', error);
      }
    }

    async function selectRoute(routeId) {
      try {
        const response = await fetch(`${API_URL}/routes/${routeId}`);
        if (!response.ok) return;
        
        currentRoute = await response.json();
        renderGrid();
        renderRouteInfo();
      } catch (error) {
        console.error('error selecting route:', error);
      }
    }

    function renderGrid() {
      if (!currentMap) {
        document.getElementById('grid').innerHTML = '<p>crea un mapa primero</p>';
        return;
      }

      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      grid.style.gridTemplateColumns = `repeat(${currentMap.dimensions.width}, 40px)`;

      const pathSet = new Set();
      if (currentRoute && currentRoute.path) {
        currentRoute.path.forEach(p => pathSet.add(`${p.x},${p.y}`));
      }

      for (let y = 0; y < currentMap.dimensions.height; y++) {
        for (let x = 0; x < currentMap.dimensions.width; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell empty';
          
          const isObstacle = currentObstacles.some(o => o.x === x && o.y === y);
          const isWaypoint = currentWaypoints.some(w => w.x === x && w.y === y);
          const isPath = pathSet.has(`${x},${y}`);
          const isStart = currentRoute && currentRoute.startX === x && currentRoute.startY === y;
          const isEnd = currentRoute && currentRoute.endX === x && currentRoute.endY === y;

          if (isStart) {
            cell.className = 'cell start';
            cell.textContent = 'S';
          } else if (isEnd) {
            cell.className = 'cell end';
            cell.textContent = 'E';
          } else if (isObstacle) {
            cell.className = 'cell obstacle';
            cell.textContent = 'â– ';
          } else if (isWaypoint) {
            cell.className = 'cell waypoint';
            cell.textContent = 'W';
          } else if (isPath) {
            cell.className = 'cell path';
            cell.textContent = 'â†’';
          } else {
            cell.textContent = `${x},${y}`;
          }

          grid.appendChild(cell);
        }
      }
    }

    function renderRouteInfo() {
      const infoDiv = document.getElementById('route-info');
      
      if (!currentRoute) {
        infoDiv.innerHTML = '<p style="color: #666;">no hay rutas calculadas</p>';
        return;
      }

      infoDiv.innerHTML = `
        <p><strong>inicio:</strong> (${currentRoute.startX}, ${currentRoute.startY})</p>
        <p><strong>fin:</strong> (${currentRoute.endX}, ${currentRoute.endY})</p>
        <p><strong>distancia:</strong> ${currentRoute.distance} pasos</p>
        <p><strong>pasos en el camino:</strong> ${currentRoute.path ? currentRoute.path.length : 0}</p>
      `;
    }

    fetchData();
    setInterval(fetchData, 2000);
  </script>
</body>
</html>
